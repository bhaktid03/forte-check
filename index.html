<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Forte Checkout Sandbox Test</title>
  <!-- 1. Load jQuery FIRST -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- 2. Load Forte Checkout script AFTER jQuery -->
  <script src="https://sandbox.forte.net/checkout/v2/js"></script>
  <!-- 3. Load CryptoJS for HMAC SHA256 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    // WARNING: Never expose your Secure Key in production! This is for sandbox/testing only.
    const apiAccessId = '419c0fd038799f51c3b714ad0f4e60f6';
    const secureApiKey = '852d14b8761f2e6e88e42e72e6e353bd';
    const organizationId = '498415';
    const locationId = '399718';
    const amount = '101.00';

    function onForteCallback(e) {
      try {
        const data = e.data || e;
        alert("Forte Callback: " + JSON.stringify(data));
        if (data.response_code === "A01") {
          alert("Payment successful! Amount: " + data.total_amount);
        } else {
          alert("Payment failed: " + (data.response_text || data.response_description));
        }
      } catch (err) {
        alert('Callback parsing error: ' + err);
      }
    }

    function openForteCheckoutSandbox(params) {
      if (typeof ForteCheckout === 'undefined') {
        setTimeout(() => openForteCheckoutSandbox(params), 100);
        return;
      }
      ForteCheckout.open({
        api_access_id: params.apiAccessId,
        signature: params.signature,
        method: "sale",
        version_number: "2.0",
        location_id: params.locationId,
        organization_id: params.organizationId,
        utc_time: params.utcTime,
        total_amount: params.amount,
        order_number: params.orderNumber,
        allowed_methods: "visa,mast,disc,amex,echeck",
        callback: "onForteCallback",
        hash_method: "sha256"
      });
    }

    function fetchUtcTimeAndOpenModal() {
      // JSONP for Forte UTC time
      const script = document.createElement('script');
      script.src = 'https://sandbox.forte.net/checkout/getUTC?callback=onUtcTimeReceived';
      document.body.appendChild(script);
    }

    function onUtcTimeReceived(utc) {
      const utcTime = utc;
      const orderNumber = `INV-${utcTime}`;
      const stringToSign = `${apiAccessId}|sale|2.0|${amount}|${utcTime}|${orderNumber}||`;
      const hash = CryptoJS.HmacSHA256(stringToSign, secureApiKey);
      const signature = hash.toString(CryptoJS.enc.Hex);

      // Expose callback globally for Forte
      window.onForteCallback = onForteCallback;

      // Open the modal
      openForteCheckoutSandbox({
        apiAccessId,
        signature,
        locationId,
        organizationId,
        utcTime,
        amount,
        orderNumber
      });
    }

    window.onload = fetchUtcTimeAndOpenModal;
  </script>
</head>
<body>
  <h3>Loading payment...</h3>
</body>
</html>
